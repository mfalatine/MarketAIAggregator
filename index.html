<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market AI Aggregator</title>
    <style>
/* ========== RESET & BASE ========== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 15px; scroll-behavior: smooth; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #f0f2f5; color: #1a1a2e; line-height: 1.6; min-height: 100vh; }

/* ========== LAYOUT & CONTAINER ========== */
.app-container { max-width: 960px; margin: 0 auto; padding: 0 16px 40px; }
header { background: #1a1a2e; color: #fff; padding: 16px 24px; margin: 0 -16px; position: sticky; top: 0; z-index: 100; }
header h1 { font-size: 1.25rem; font-weight: 600; margin-bottom: 10px; letter-spacing: 0.5px; }
header h1 span.version { font-size: 0.75rem; font-weight: 400; opacity: 0.6; margin-left: 8px; }

/* ========== TAB NAVIGATION ========== */
.tab-nav { display: flex; gap: 4px; flex-wrap: wrap; }
.tab-btn { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.7); border: none; padding: 8px 16px; border-radius: 6px 6px 0 0; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.2s; }
.tab-btn:hover { background: rgba(255,255,255,0.15); color: #fff; }
.tab-btn.active { background: #f0f2f5; color: #1a1a2e; }
.tab-content { display: none; padding-top: 20px; }
.tab-content.active { display: block; }

/* ========== CARDS & PANELS ========== */
.card { background: #fff; border-radius: 8px; padding: 20px 24px; margin-bottom: 16px; border: 1px solid #e2e5ea; }
.card h3 { font-size: 1rem; font-weight: 600; color: #1a1a2e; margin-bottom: 14px; text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.8rem; }
.card-section { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f0f2f5; }
.card-section:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }

/* ========== FORMS & INPUTS ========== */
label { font-size: 0.85rem; font-weight: 500; color: #444; display: block; margin-bottom: 4px; }
input[type="text"], input[type="password"], input[type="number"], select, textarea {
    width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem;
    font-family: inherit; background: #fff; color: #1a1a2e; transition: border-color 0.2s;
}
input:focus, textarea:focus, select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
textarea { resize: vertical; min-height: 80px; }
.input-row { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 10px; }
.input-row .field { flex: 1; }
.input-group { display: flex; gap: 0; }
.input-group input { border-radius: 6px 0 0 6px; }
.input-group button { border-radius: 0 6px 6px 0; white-space: nowrap; }

/* Radio & Checkbox Groups */
.radio-group, .checkbox-group { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 6px; }
.radio-option, .checkbox-option { display: flex; align-items: flex-start; gap: 6px; padding: 8px 12px; border: 1px solid #e2e5ea; border-radius: 6px; cursor: pointer; transition: all 0.2s; flex: 1; min-width: 200px; }
.radio-option:hover, .checkbox-option:hover { border-color: #3b82f6; background: #f8faff; }
.radio-option input, .checkbox-option input { margin-top: 3px; }
.radio-option .option-info, .checkbox-option .option-info { flex: 1; }
.option-label { font-weight: 500; font-size: 0.85rem; color: #1a1a2e; }
.option-desc { font-size: 0.75rem; color: #666; margin-top: 2px; }
.topic-group-label { font-weight: 600; font-size: 0.8rem; color: #666; margin: 12px 0 6px; text-transform: uppercase; letter-spacing: 0.5px; }
.topic-group-label:first-child { margin-top: 0; }

/* ========== BUTTONS ========== */
.btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.2s; font-family: inherit; background: #fff; color: #374151; }
.btn:hover { background: #f9fafb; border-color: #9ca3af; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-primary { background: #3b82f6; color: #fff; border-color: #3b82f6; }
.btn-primary:hover { background: #2563eb; border-color: #2563eb; }
.btn-danger { background: #fff; color: #dc2626; border-color: #fca5a5; }
.btn-danger:hover { background: #fef2f2; border-color: #dc2626; }
.btn-sm { padding: 4px 10px; font-size: 0.78rem; }
.btn-icon { padding: 4px 8px; font-size: 0.85rem; line-height: 1; }
.button-row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
.button-row-right { justify-content: flex-end; }

/* ========== TAGS / PILLS ========== */
.tag-container { display: flex; flex-wrap: wrap; gap: 6px; margin: 8px 0; }
.tag { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; background: #e8f0fe; color: #1a56db; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
.tag .tag-remove { cursor: pointer; font-size: 1rem; line-height: 1; opacity: 0.6; }
.tag .tag-remove:hover { opacity: 1; color: #dc2626; }

/* ========== STATUS INDICATORS ========== */
.status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
.status-dot.green { background: #22c55e; }
.status-dot.gray { background: #9ca3af; }
.status-dot.orange { background: #f59e0b; }
.status-dot.red { background: #ef4444; }
.status-line { display: flex; align-items: center; font-size: 0.85rem; margin-top: 6px; }
.banner { padding: 12px 16px; border-radius: 6px; margin-bottom: 16px; font-size: 0.85rem; }
.banner-warning { background: #fef3cd; color: #856404; border: 1px solid #ffeaa7; }
.banner-error { background: #fce4ec; color: #c62828; border: 1px solid #f8bbd0; }

/* ========== DASHBOARD ========== */
#prompt-section, #status-section, #briefing-section { display: none; }
.prompt-textarea { font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace; font-size: 0.82rem; line-height: 1.5; min-height: 200px; }
.prompt-hint { font-size: 0.78rem; color: #888; margin-top: 6px; font-style: italic; }
.spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid #e2e5ea; border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 8px; vertical-align: middle; }
@keyframes spin { to { transform: rotate(360deg); } }
.briefing-header { margin-bottom: 16px; }
.briefing-meta { display: flex; gap: 16px; font-size: 0.8rem; color: #666; flex-wrap: wrap; align-items: center; }
.briefing-meta .modified-flag { color: #f59e0b; cursor: pointer; text-decoration: underline; }
.briefing-body { line-height: 1.7; font-size: 0.92rem; }
.briefing-body h2 { font-size: 1.05rem; font-weight: 700; margin: 20px 0 8px; color: #1a1a2e; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #e2e5ea; padding-bottom: 4px; }
.briefing-body h3 { font-size: 0.95rem; font-weight: 600; margin: 16px 0 6px; color: #374151; }
.briefing-body h4 { font-size: 0.9rem; font-weight: 600; margin: 12px 0 4px; color: #4b5563; }
.briefing-body p { margin-bottom: 10px; }
.briefing-body ul, .briefing-body ol { margin: 8px 0 12px 20px; }
.briefing-body li { margin-bottom: 4px; }
.briefing-body strong { color: #1a1a2e; }
.briefing-body hr { border: none; border-top: 1px solid #e2e5ea; margin: 16px 0; }
.briefing-body blockquote { border-left: 3px solid #3b82f6; padding-left: 12px; margin: 10px 0; color: #555; }
.export-row { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-top: 16px; padding-top: 16px; border-top: 1px solid #e2e5ea; }
.export-row label { margin-bottom: 0; font-size: 0.82rem; }

/* ========== HISTORY ========== */
.history-header { display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 14px; }
.history-header h3 { margin-bottom: 0; }
.history-search { max-width: 250px; }
.history-list { list-style: none; }
.history-item { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-bottom: 1px solid #f0f2f5; cursor: pointer; transition: background 0.15s; }
.history-item:hover { background: #f8faff; }
.history-item:last-child { border-bottom: none; }
.history-date { font-weight: 600; font-size: 0.85rem; min-width: 60px; color: #1a1a2e; }
.history-model { font-size: 0.75rem; font-weight: 500; min-width: 55px; }
.history-preview { font-size: 0.82rem; color: #666; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.history-compare-cb { flex-shrink: 0; }
.compare-container { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.compare-side { border: 1px solid #e2e5ea; border-radius: 6px; padding: 16px; overflow: auto; max-height: 600px; }
.compare-side h4 { margin-bottom: 10px; font-size: 0.85rem; color: #666; }
.no-history { text-align: center; padding: 40px; color: #999; font-size: 0.9rem; }

/* ========== ADMIN ========== */
.admin-section { margin-bottom: 24px; }
.admin-item { display: flex; justify-content: space-between; align-items: flex-start; padding: 10px 12px; border: 1px solid #e2e5ea; border-radius: 6px; margin-bottom: 6px; }
.admin-item-info { flex: 1; }
.admin-item-name { font-weight: 600; font-size: 0.88rem; }
.admin-item-meta { font-size: 0.78rem; color: #888; margin-top: 2px; }
.admin-item-hint { font-size: 0.78rem; color: #666; margin-top: 4px; font-style: italic; background: #f9fafb; padding: 4px 8px; border-radius: 4px; }
.admin-item-actions { display: flex; gap: 4px; flex-shrink: 0; margin-left: 10px; }
.admin-form { background: #f9fafb; border: 1px dashed #d1d5db; border-radius: 6px; padding: 16px; margin-top: 10px; display: none; }
.admin-form.visible { display: block; }
.admin-form .field { margin-bottom: 10px; }
.var-list { font-size: 0.78rem; color: #888; margin-top: 6px; }
.var-list code { background: #f0f2f5; padding: 1px 5px; border-radius: 3px; font-size: 0.75rem; }
.prompt-preview-box { background: #f9fafb; border: 1px solid #e2e5ea; border-radius: 6px; padding: 14px; margin-top: 10px; font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace; font-size: 0.8rem; white-space: pre-wrap; line-height: 1.5; max-height: 400px; overflow-y: auto; display: none; }

/* ========== USER GUIDE ========== */
.guide-nav { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #e2e5ea; }
.guide-nav a { padding: 5px 12px; background: #f0f2f5; color: #374151; border-radius: 20px; font-size: 0.78rem; text-decoration: none; font-weight: 500; transition: all 0.2s; }
.guide-nav a:hover { background: #3b82f6; color: #fff; }
.guide-section { margin-bottom: 28px; }
.guide-section h4 { font-size: 0.95rem; font-weight: 600; color: #1a1a2e; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 2px solid #e2e5ea; }
.guide-section p { font-size: 0.88rem; margin-bottom: 8px; color: #374151; }
.guide-section ul, .guide-section ol { font-size: 0.88rem; margin: 6px 0 12px 20px; color: #374151; }
.guide-section li { margin-bottom: 4px; }
.guide-section .note { font-size: 0.82rem; color: #666; padding: 8px 12px; background: #f8faff; border-left: 3px solid #3b82f6; margin: 8px 0; border-radius: 0 4px 4px 0; }
.guide-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; margin: 10px 0; }
.guide-table th, .guide-table td { padding: 6px 10px; border: 1px solid #e2e5ea; text-align: left; }
.guide-table th { background: #f0f2f5; font-weight: 600; }
.guide-section .warning { font-size: 0.82rem; color: #856404; padding: 8px 12px; background: #fef3cd; border-left: 3px solid #f59e0b; margin: 8px 0; border-radius: 0 4px 4px 0; }

/* ========== MODAL ========== */
.modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; }
.modal-overlay.visible { display: flex; }
.modal { background: #fff; border-radius: 10px; padding: 24px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
.modal h3 { margin-bottom: 12px; }
.modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; }
.modal pre { background: #f9fafb; padding: 12px; border-radius: 6px; font-size: 0.8rem; white-space: pre-wrap; overflow-x: auto; max-height: 400px; overflow-y: auto; }

/* ========== TOAST ========== */
.toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 300; }
.toast { padding: 10px 18px; border-radius: 8px; font-size: 0.85rem; font-weight: 500; color: #fff; margin-top: 8px; animation: toastIn 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
.toast.success { background: #22c55e; }
.toast.error { background: #ef4444; }
.toast.info { background: #3b82f6; }
@keyframes toastIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* ========== DATA MANAGEMENT ========== */
.data-section { margin-top: 8px; }
.data-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; flex-wrap: wrap; }
.data-row-label { font-size: 0.82rem; font-weight: 600; color: #374151; min-width: 100px; }
.data-row-desc { font-size: 0.78rem; color: #888; margin-top: 2px; }
.danger-zone { border: 1px solid #fca5a5; border-radius: 6px; padding: 16px; margin-top: 12px; }
.danger-zone h4 { color: #dc2626; font-size: 0.82rem; margin-bottom: 10px; }

/* ========== RESPONSIVE ========== */
@media (max-width: 640px) {
    .radio-option, .checkbox-option { min-width: 100%; }
    .compare-container { grid-template-columns: 1fr; }
    .history-header { flex-direction: column; align-items: stretch; }
    .history-search { max-width: 100%; }
    .input-row { flex-direction: column; }
    header h1 { font-size: 1.1rem; }
}

/* ========== PRINT STYLES ========== */
@media print {
    header, .tab-nav, .export-row, .button-row, #generate-section, #prompt-section, #status-section, .btn { display: none !important; }
    .app-container { max-width: 100%; padding: 0; }
    .card { border: none; box-shadow: none; padding: 0; }
    .tab-content { display: none !important; }
    #tab-dashboard { display: block !important; }
    #briefing-section { display: block !important; }
    .briefing-body { font-size: 11pt; }
}
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <h1>Market AI Aggregator <span class="version">X1</span></h1>
            <nav class="tab-nav">
                <button class="tab-btn active" data-tab="dashboard">Dashboard</button>
                <button class="tab-btn" data-tab="history">History</button>
                <button class="tab-btn" data-tab="settings">Settings</button>
                <button class="tab-btn" data-tab="admin">üîß Admin</button>
                <button class="tab-btn" data-tab="guide">üìñ Guide</button>
            </nav>
        </header>

        <main>
            <!-- ==================== DASHBOARD TAB ==================== -->
            <div id="tab-dashboard" class="tab-content active">
                <div class="card" id="generate-section">
                    <h3>Generate Briefing</h3>
                    <div class="input-row">
                        <div class="field">
                            <label for="dashboard-model">Model</label>
                            <select id="dashboard-model"></select>
                        </div>
                        <div class="field" style="flex:0">
                            <label>&nbsp;</label>
                            <button class="btn btn-primary" onclick="buildPrompt()">‚ñ∂ Build Prompt</button>
                        </div>
                    </div>
                </div>

                <div class="card" id="prompt-section">
                    <h3>Assembled Prompt</h3>
                    <textarea id="prompt-textarea" class="prompt-textarea"></textarea>
                    <p class="prompt-hint">Edits here are one-time only. To change the template permanently, use the Admin tab.</p>
                    <div class="button-row">
                        <button class="btn" onclick="resetPrompt()">‚Ü∫ Reset to Template</button>
                        <button class="btn btn-primary" id="btn-run" onclick="runBriefing()">‚ñ∂ Run Briefing</button>
                    </div>
                </div>

                <div class="card" id="status-section">
                    <div class="status-line">
                        <span class="spinner"></span>
                        <span id="status-text">Generating briefing...</span>
                    </div>
                </div>

                <div class="card" id="briefing-section">
                    <div class="briefing-header">
                        <h3 id="briefing-date"></h3>
                        <div class="briefing-meta">
                            <span id="briefing-model"></span>
                            <span id="briefing-time"></span>
                            <span id="briefing-modified" class="modified-flag" style="display:none" onclick="viewSentPrompt()">[modified from template]</span>
                        </div>
                    </div>
                    <div id="briefing-content" class="briefing-body"></div>
                    <div class="export-row">
                        <label><input type="checkbox" id="chk-snapshot"> Include Settings Snapshot</label>
                        <button class="btn btn-sm" onclick="copyBriefing()">üìã Copy</button>
                        <button class="btn btn-sm" onclick="exportBriefingHTML()">üìÑ Export HTML</button>
                        <button class="btn btn-sm" onclick="printBriefing()">üñ® Print</button>
                        <button class="btn btn-sm" onclick="regenerateBriefing()">üîÑ Regenerate</button>
                    </div>
                </div>
            </div>

            <!-- ==================== HISTORY TAB ==================== -->
            <div id="tab-history" class="tab-content">
                <div class="card">
                    <div class="history-header">
                        <h3>Briefing History</h3>
                        <input type="text" id="history-search" class="history-search" placeholder="Search briefings...">
                    </div>
                    <div id="history-list"></div>
                    <div class="button-row" id="history-compare-row" style="display:none">
                        <button class="btn btn-primary btn-sm" onclick="compareSelected()">Compare Selected</button>
                    </div>
                </div>

                <div class="card" id="history-view" style="display:none">
                    <div class="button-row" style="margin-top:0;margin-bottom:12px">
                        <button class="btn btn-sm" onclick="backToHistoryList()">‚Üê Back to List</button>
                        <button class="btn btn-sm" onclick="viewHistoryPrompt()">View Prompt Sent</button>
                    </div>
                    <div id="history-briefing-header"></div>
                    <div id="history-briefing-content" class="briefing-body"></div>
                </div>

                <div class="card" id="history-compare" style="display:none">
                    <div class="button-row" style="margin-top:0;margin-bottom:12px">
                        <button class="btn btn-sm" onclick="backToHistoryList()">‚Üê Back to List</button>
                    </div>
                    <div class="compare-container">
                        <div class="compare-side" id="compare-left"></div>
                        <div class="compare-side" id="compare-right"></div>
                    </div>
                </div>
            </div>

            <!-- ==================== SETTINGS TAB ==================== -->
            <div id="tab-settings" class="tab-content">
                <div id="settings-banner"></div>

                <div class="card">
                    <h3>API Configuration</h3>
                    <div class="field">
                        <label for="settings-apikey">Anthropic API Key</label>
                        <div class="input-group">
                            <input type="password" id="settings-apikey" placeholder="sk-ant-...">
                            <button class="btn" onclick="toggleApiKeyVis()">Show</button>
                        </div>
                    </div>
                    <div class="status-line" id="apikey-status">
                        <span class="status-dot gray"></span> Not Set
                    </div>
                </div>

                <div class="card">
                    <h3>Model Selection</h3>
                    <div id="settings-models" class="radio-group"></div>
                </div>

                <div class="card">
                    <h3>Briefing Topics</h3>
                    <div id="settings-topics"></div>
                </div>

                <div class="card">
                    <h3>Watchlist</h3>
                    <div class="card-section">
                        <label>Tickers</label>
                        <div class="tag-container" id="watchlist-tags"></div>
                        <div class="input-group" style="max-width:200px">
                            <input type="text" id="watchlist-input" placeholder="Add ticker" maxlength="5">
                            <button class="btn" onclick="addWatchlistTicker()">+</button>
                        </div>
                    </div>
                    <div class="card-section">
                        <label>Watchlist Coverage</label>
                        <div id="settings-coverage" class="checkbox-group"></div>
                    </div>
                </div>

                <div class="card">
                    <h3>Output Preferences</h3>
                    <div class="card-section">
                        <label>Briefing Style</label>
                        <div id="settings-styles" class="radio-group"></div>
                    </div>
                    <div class="card-section">
                        <label for="settings-instructions">Custom Instructions</label>
                        <textarea id="settings-instructions" rows="3"></textarea>
                    </div>
                </div>

                <div class="card">
                    <h3>Data Management</h3>
                    <div class="data-section">
                        <div class="data-row-label">Settings</div>
                        <div class="data-row">
                            <button class="btn btn-sm" onclick="exportSettings()">Export Settings JSON</button>
                            <button class="btn btn-sm" onclick="importSettings()">Import Settings JSON</button>
                        </div>
                        <div class="data-row-desc">API key, model, topics, watchlist, style, custom instructions</div>
                    </div>
                    <div class="data-section">
                        <div class="data-row-label">History</div>
                        <div class="data-row">
                            <button class="btn btn-sm" onclick="exportHistory()">Export History JSON</button>
                            <button class="btn btn-sm" onclick="importHistory()">Import History JSON</button>
                        </div>
                        <div class="data-row-desc">All past briefings with dates, model used, and content</div>
                    </div>
                    <div class="data-section">
                        <div class="data-row-label">Full Backup</div>
                        <div class="data-row">
                            <button class="btn btn-sm" onclick="exportEverything()">Export Everything</button>
                            <button class="btn btn-sm" onclick="importEverything()">Import Everything</button>
                        </div>
                        <div class="data-row-desc">Settings + History in one file</div>
                    </div>
                    <div class="danger-zone">
                        <h4>Danger Zone</h4>
                        <div class="data-row">
                            <button class="btn btn-danger btn-sm" onclick="clearHistoryOnly()">Clear History Only</button>
                            <button class="btn btn-danger btn-sm" onclick="resetEverything()">Reset Everything</button>
                        </div>
                    </div>
                </div>

                <div class="button-row button-row-right">
                    <button class="btn btn-primary" onclick="saveAllSettings()">Save Settings</button>
                </div>
            </div>

            <!-- ==================== ADMIN TAB ==================== -->
            <div id="tab-admin" class="tab-content">
                <!-- Topic Management -->
                <div class="card admin-section">
                    <h3>Topic Management</h3>
                    <div class="field" style="max-width:250px;margin-bottom:12px">
                        <label for="admin-topic-filter">Category Filter</label>
                        <select id="admin-topic-filter" onchange="renderTopicManagement()">
                            <option value="all">All Categories</option>
                        </select>
                    </div>
                    <div id="admin-topic-list"></div>
                    <button class="btn btn-sm" onclick="toggleAdminForm('topic-form')" id="btn-add-topic">+ Add Topic</button>
                    <div class="admin-form" id="topic-form">
                        <div class="field">
                            <label>Category</label>
                            <select id="topic-form-category"></select>
                        </div>
                        <div class="field">
                            <label>Display Name</label>
                            <input type="text" id="topic-form-name" oninput="autoGenerateKey()">
                        </div>
                        <div class="field">
                            <label>Key</label>
                            <input type="text" id="topic-form-key">
                        </div>
                        <div class="field">
                            <label>Prompt Hint</label>
                            <textarea id="topic-form-hint" rows="2" placeholder="What should Claude search for when this topic is enabled?"></textarea>
                        </div>
                        <input type="hidden" id="topic-form-edit-id">
                        <div class="button-row">
                            <button class="btn btn-primary btn-sm" onclick="saveTopic()">Save Topic</button>
                            <button class="btn btn-sm" onclick="cancelTopicForm()">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- Category Management -->
                <div class="card admin-section">
                    <h3>Category Management</h3>
                    <div id="admin-category-list"></div>
                    <button class="btn btn-sm" onclick="toggleAdminForm('category-form')">+ Add Category</button>
                    <div class="admin-form" id="category-form">
                        <div class="input-row">
                            <div class="field">
                                <label>Name</label>
                                <input type="text" id="category-form-name">
                            </div>
                            <div class="field" style="max-width:80px">
                                <label>Sort</label>
                                <input type="number" id="category-form-sort" value="1" min="1">
                            </div>
                        </div>
                        <input type="hidden" id="category-form-edit-id">
                        <div class="button-row">
                            <button class="btn btn-primary btn-sm" onclick="saveCategory()">Save Category</button>
                            <button class="btn btn-sm" onclick="cancelCategoryForm()">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- Coverage Type Management -->
                <div class="card admin-section">
                    <h3>Watchlist Coverage Options</h3>
                    <div id="admin-coverage-list"></div>
                    <button class="btn btn-sm" onclick="toggleAdminForm('coverage-form')">+ Add Coverage Type</button>
                    <div class="admin-form" id="coverage-form">
                        <div class="field">
                            <label>Name</label>
                            <input type="text" id="coverage-form-name">
                        </div>
                        <div class="field">
                            <label>Prompt Instruction</label>
                            <textarea id="coverage-form-prompt" rows="2"></textarea>
                        </div>
                        <input type="hidden" id="coverage-form-edit-id">
                        <div class="button-row">
                            <button class="btn btn-primary btn-sm" onclick="saveCoverageType()">Save Coverage Type</button>
                            <button class="btn btn-sm" onclick="cancelCoverageForm()">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- Prompt Editor -->
                <div class="card admin-section">
                    <h3>Prompt Editor</h3>
                    <div class="card-section">
                        <label for="admin-system-prompt">System Prompt</label>
                        <textarea id="admin-system-prompt" rows="8"></textarea>
                        <div class="button-row">
                            <button class="btn btn-sm" onclick="resetSystemPrompt()">Reset to Default</button>
                            <button class="btn btn-primary btn-sm" onclick="saveSystemPrompt()">Save System Prompt</button>
                        </div>
                    </div>
                    <div class="card-section">
                        <label for="admin-user-template">User Prompt Template</label>
                        <textarea id="admin-user-template" rows="8"></textarea>
                        <div class="var-list">
                            Available variables: <code>{date}</code> <code>{enabled_topics}</code> <code>{watchlist}</code> <code>{coverage_types}</code> <code>{briefing_style}</code> <code>{custom_instructions}</code> <code>{topic_hints}</code>
                        </div>
                        <div class="button-row">
                            <button class="btn btn-sm" onclick="resetUserTemplate()">Reset to Default</button>
                            <button class="btn btn-primary btn-sm" onclick="saveUserTemplate()">Save Template</button>
                        </div>
                    </div>
                    <div class="card-section">
                        <button class="btn btn-sm" onclick="previewFullPrompt()">üëÅ Preview Full Prompt</button>
                        <div class="prompt-preview-box" id="prompt-preview"></div>
                    </div>
                </div>

                <!-- Style Management -->
                <div class="card admin-section">
                    <h3>Briefing Style Options</h3>
                    <div id="admin-style-list"></div>
                    <button class="btn btn-sm" onclick="toggleAdminForm('style-form')">+ Add Style</button>
                    <div class="admin-form" id="style-form">
                        <div class="input-row">
                            <div class="field"><label>Name</label><input type="text" id="style-form-name"></div>
                            <div class="field" style="max-width:120px"><label>Word Target</label><input type="number" id="style-form-words" value="500"></div>
                            <div class="field" style="max-width:120px"><label>Max Tokens</label><input type="number" id="style-form-tokens" value="1000"></div>
                        </div>
                        <div class="field">
                            <label>Description</label>
                            <input type="text" id="style-form-desc">
                        </div>
                        <input type="hidden" id="style-form-edit-id">
                        <div class="button-row">
                            <button class="btn btn-primary btn-sm" onclick="saveStyle()">Save Style</button>
                            <button class="btn btn-sm" onclick="cancelStyleForm()">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- Model Management -->
                <div class="card admin-section">
                    <h3>Model Management</h3>
                    <div id="admin-model-list"></div>
                    <button class="btn btn-sm" onclick="toggleAdminForm('model-form')">+ Add Model</button>
                    <div class="admin-form" id="model-form">
                        <div class="field">
                            <label>API Model ID</label>
                            <input type="text" id="model-form-id" placeholder="claude-sonnet-4-5-20250929">
                        </div>
                        <div class="input-row">
                            <div class="field"><label>Display Name</label><input type="text" id="model-form-name"></div>
                            <div class="field"><label>Cost Note</label><input type="text" id="model-form-cost" placeholder="Fast, ~$0.05/run"></div>
                        </div>
                        <input type="hidden" id="model-form-edit-id">
                        <div class="button-row">
                            <button class="btn btn-primary btn-sm" onclick="saveModel()">Save Model</button>
                            <button class="btn btn-sm" onclick="cancelModelForm()">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== USER GUIDE TAB ==================== -->
            <div id="tab-guide" class="tab-content">
                <div class="card">
                    <h3>User Guide</h3>
                    <nav class="guide-nav">
                        <a href="#" onclick="scrollGuide('guide-start');return false">Getting Started</a>
                        <a href="#" onclick="scrollGuide('guide-dashboard');return false">Dashboard</a>
                        <a href="#" onclick="scrollGuide('guide-history');return false">History</a>
                        <a href="#" onclick="scrollGuide('guide-settings');return false">Settings</a>
                        <a href="#" onclick="scrollGuide('guide-admin');return false">Admin</a>
                        <a href="#" onclick="scrollGuide('guide-data');return false">Data &amp; Backup</a>
                        <a href="#" onclick="scrollGuide('guide-trouble');return false">Troubleshooting</a>
                        <a href="#" onclick="scrollGuide('guide-cost');return false">Cost Reference</a>
                    </nav>

                    <div class="guide-section" id="guide-start">
                        <h4>Getting Started</h4>
                        <p>This app generates AI-powered daily market briefings by sending a customized prompt to the Anthropic API with web search enabled. Claude searches live sources (CME FedWatch, BLS, financial news) and synthesizes a briefing based on your selected topics, watchlist, and style preferences.</p>
                        <p>Everything runs in your browser. Your API key and settings are stored in localStorage ‚Äî nothing is sent anywhere except the Anthropic API when you click "Run Briefing."</p>
                        <p><strong>First-time setup:</strong></p>
                        <ol>
                            <li>Go to Settings ‚Üí enter your Anthropic API key</li>
                            <li>Select your default model, topics, and watchlist</li>
                            <li>Go to Dashboard ‚Üí Build Prompt ‚Üí Run Briefing</li>
                        </ol>
                    </div>

                    <div class="guide-section" id="guide-dashboard">
                        <h4>Dashboard</h4>
                        <p><strong>Build Prompt</strong> ‚Äî Assembles a prompt from your saved template, enabled topics (with their prompt hints), watchlist, coverage types, and style setting. The result appears in an editable text area.</p>
                        <p class="note">No API call is made. Nothing is sent yet.</p>
                        <p><strong>Edit the Prompt (optional)</strong> ‚Äî You can modify the assembled prompt before running. Examples:</p>
                        <ul>
                            <li>Add a ticker: "Also cover AVGO today"</li>
                            <li>Shift focus: "Go deeper on Fed policy, skip techs"</li>
                            <li>Add context: "Note: NVDA earnings was yesterday"</li>
                        </ul>
                        <p class="note">Edits are one-time only. The saved template is not affected. Use Admin to change permanently.</p>
                        <p><strong>Run Briefing</strong> ‚Äî Sends the prompt to the Anthropic API with web search. Result is displayed and auto-saved to History. If the prompt was edited, it's flagged as "modified from template."</p>
                        <p><strong>Model Override</strong> ‚Äî The dropdown lets you override the default model for a single run. Use Sonnet for daily briefings, switch to Opus for deeper weekend reviews.</p>
                        <p class="note">Only affects this run. Default is not changed.</p>
                        <p><strong>Regenerate</strong> ‚Äî Re-runs the same prompt. New API call. Previous version remains in History.</p>
                        <p><strong>Copy / Export HTML / Print</strong> ‚Äî Local actions only, no API calls. Check "Include Settings Snapshot" to bundle configuration details with the export.</p>
                    </div>

                    <div class="guide-section" id="guide-history">
                        <h4>History</h4>
                        <p>Every generated briefing is automatically saved with its date, model used, prompt sent, and full response.</p>
                        <p><strong>View Past Briefing</strong> ‚Äî Click any entry to see the full briefing. Click "View Prompt" to see exactly what was sent.</p>
                        <p><strong>Compare</strong> ‚Äî Select two briefings to see a side-by-side comparison ‚Äî useful for tracking evolving narratives.</p>
                        <p><strong>Search</strong> ‚Äî Full-text search across all saved briefings.</p>
                        <p class="note">All history operations are local. No API calls.</p>
                    </div>

                    <div class="guide-section" id="guide-settings">
                        <h4>Settings</h4>
                        <p><strong>API Key</strong> ‚Äî Stored in localStorage only. Validated with a lightweight test call when entered.</p>
                        <p><strong>Default Model</strong> ‚Äî Sets which model is pre-selected on Dashboard. Can be overridden per-run.</p>
                        <p><strong>Topics</strong> ‚Äî Toggle which topics are included when building a prompt. Each has a prompt hint (editable in Admin).</p>
                        <p><strong>Watchlist</strong> ‚Äî Your tracked tickers, injected into the prompt so Claude searches for news about these symbols.</p>
                        <p><strong>Watchlist Coverage</strong> ‚Äî What type of information to gather per ticker (news, earnings, analyst changes, etc.).</p>
                        <p><strong>Output Style</strong> ‚Äî Controls response length, depth, and max_tokens sent to the API.</p>
                        <p><strong>Custom Instructions</strong> ‚Äî Free-text appended to every prompt for persistent preferences.</p>
                    </div>

                    <div class="guide-section" id="guide-admin">
                        <h4>Admin</h4>
                        <p>Admin controls <strong>what options exist</strong>. Settings controls <strong>which options are active</strong>. Think of Admin as building the menu, Settings as ordering from it.</p>
                        <p><strong>Topic Management</strong> ‚Äî Add, edit, or remove topics. Each has a display name, category, and prompt hint that tells Claude what to search for.</p>
                        <p><strong>Category Management</strong> ‚Äî Add or rename topic groupings. Sort order controls display sequence.</p>
                        <p><strong>Watchlist Coverage Types</strong> ‚Äî Define what types of coverage are available for watchlist tickers.</p>
                        <p><strong>Prompt Editor</strong> ‚Äî Direct access to the system prompt and user prompt template with variable placeholders.</p>
                        <p class="warning">‚ö† The system prompt defines Claude's persona and rules. Edit carefully ‚Äî bad system prompts produce bad briefings. Use "Reset to Default" if things go sideways.</p>
                        <p><strong>Briefing Styles</strong> ‚Äî Add custom styles beyond the defaults.</p>
                        <p><strong>Model Management</strong> ‚Äî Add new models as Anthropic releases them.</p>
                    </div>

                    <div class="guide-section" id="guide-data">
                        <h4>Data &amp; Backup</h4>
                        <p>All data lives in your browser's localStorage. Clearing browser data will erase everything. Use exports to protect your data.</p>
                        <table class="guide-table">
                            <thead><tr><th>Action</th><th>What It Does</th></tr></thead>
                            <tbody>
                                <tr><td>Export Settings</td><td>Config only, no history</td></tr>
                                <tr><td>Import Settings</td><td>Overwrites current config</td></tr>
                                <tr><td>Export History</td><td>All briefings as JSON</td></tr>
                                <tr><td>Import History</td><td>Merges with existing (no dupes)</td></tr>
                                <tr><td>Export Everything</td><td>Single backup file</td></tr>
                                <tr><td>Import Everything</td><td>Full restore</td></tr>
                            </tbody>
                        </table>
                        <p><strong>Moving to a new browser/machine:</strong></p>
                        <ol>
                            <li>Export Everything from old browser</li>
                            <li>Open app in new browser</li>
                            <li>Import Everything ‚Üí fully restored</li>
                        </ol>
                    </div>

                    <div class="guide-section" id="guide-trouble">
                        <h4>Troubleshooting</h4>
                        <p><strong>"API key invalid"</strong> ‚Äî Check your key at console.anthropic.com. Ensure it starts with "sk-ant-". Keys are project-scoped ‚Äî make sure it has Messages API access.</p>
                        <p><strong>Briefing is vague or missing data:</strong></p>
                        <ul>
                            <li>Check prompt hints in Admin ‚Äî vague hints produce vague results</li>
                            <li>Try Opus for deeper synthesis</li>
                            <li>Add specific instructions in the editable prompt</li>
                            <li>Web search can miss recent events ‚Äî try Regenerate</li>
                        </ul>
                        <p><strong>Briefing is too long / too short</strong> ‚Äî Adjust the style in Settings or edit max_tokens for the style in Admin.</p>
                        <p><strong>Response cut off mid-sentence</strong> ‚Äî max_tokens too low. Go to Admin ‚Üí Briefing Styles ‚Üí increase max_tokens.</p>
                        <p><strong>"Rate limited"</strong> ‚Äî Wait a minute and try again. Rare with single daily briefings.</p>
                    </div>

                    <div class="guide-section" id="guide-cost">
                        <h4>Cost Reference</h4>
                        <p>Costs are per-run and depend on model + response length + web searches:</p>
                        <table class="guide-table">
                            <thead><tr><th>Configuration</th><th>Estimated Cost</th></tr></thead>
                            <tbody>
                                <tr><td>Sonnet + Concise</td><td>~$0.03‚Äì0.05</td></tr>
                                <tr><td>Sonnet + Standard</td><td>~$0.05‚Äì0.10</td></tr>
                                <tr><td>Sonnet + Deep Dive</td><td>~$0.10‚Äì0.15</td></tr>
                                <tr><td>Opus + Concise</td><td>~$0.15‚Äì0.25</td></tr>
                                <tr><td>Opus + Standard</td><td>~$0.25‚Äì0.40</td></tr>
                                <tr><td>Opus + Deep Dive</td><td>~$0.40‚Äì0.60</td></tr>
                                <tr><td>Daily Sonnet/Standard</td><td>~$2‚Äì3/month</td></tr>
                                <tr><td>Daily Opus/Standard</td><td>~$8‚Äì12/month</td></tr>
                            </tbody>
                        </table>
                        <p>Check usage at <strong>console.anthropic.com/usage</strong></p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
        <div class="modal" id="modal">
            <h3 id="modal-title"></h3>
            <div id="modal-body"></div>
            <div class="modal-actions">
                <button class="btn btn-sm" onclick="hideModal()">Close</button>
                <button class="btn btn-primary btn-sm" id="modal-confirm" style="display:none" onclick="confirmModal()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script>
// ================================================================
// SECTION 1: CONSTANTS & DEFAULT DATA
// ================================================================
const DEFAULT_ADMIN = {
    categories: [
        { id: 'macro_policy', name: 'Macro / Policy', sort: 1 },
        { id: 'market_technicals', name: 'Market / Technicals', sort: 2 },
        { id: 'company_earnings', name: 'Company / Earnings', sort: 3 }
    ],
    topics: [
        { id: 'fed_policy', name: 'Fed Policy & Rate Expectations', category: 'macro_policy', prompt_hint: 'Include CME FedWatch probabilities, next FOMC date, and recent Fed speaker commentary' },
        { id: 'economic_calendar', name: 'Economic Calendar & Data Releases', category: 'macro_policy', prompt_hint: 'List upcoming releases this week with expected vs prior values' },
        { id: 'geopolitical', name: 'Geopolitical Events', category: 'macro_policy', prompt_hint: 'Major geopolitical developments affecting global markets' },
        { id: 'bonds', name: 'Treasury/Bond Market', category: 'macro_policy', prompt_hint: '10Y yield level, yield curve shape, recent auction results' },
        { id: 'sp500_technicals', name: 'S&P 500 Technical Levels', category: 'market_technicals', prompt_hint: 'Current level, key support/resistance, moving averages, recent breakouts or breakdowns' },
        { id: 'vix_sentiment', name: 'VIX / Sentiment Indicators', category: 'market_technicals', prompt_hint: 'VIX level and trend, put/call ratio, AAII sentiment survey, fear/greed index' },
        { id: 'sector_rotation', name: 'Sector Rotation / Fund Flows', category: 'market_technicals', prompt_hint: 'Leading/lagging sectors, notable ETF inflows/outflows, rotation trends' },
        { id: 'market_breadth', name: 'Market Breadth', category: 'market_technicals', prompt_hint: 'Advance/decline ratio, new highs vs new lows, percentage of stocks above 200-day MA' },
        { id: 'earnings_notable', name: 'Notable Earnings (upcoming & recent)', category: 'company_earnings', prompt_hint: 'Major earnings reports this week with consensus estimates and recent notable beats/misses' },
        { id: 'insider_trading', name: 'Insider Trading / Buybacks', category: 'company_earnings', prompt_hint: 'Notable insider buys/sells and major corporate buyback announcements' },
        { id: 'ipo_calendar', name: 'IPO Calendar', category: 'company_earnings', prompt_hint: 'Upcoming IPOs and recent IPO performance' }
    ],
    coverage_types: [
        { id: 'price_moving_news', name: 'Price-moving news', prompt: 'Breaking news likely to move share price >2% for these tickers' },
        { id: 'upcoming_earnings', name: 'Upcoming earnings dates', prompt: 'Next earnings date and consensus EPS estimate' },
        { id: 'analyst_ratings', name: 'Analyst rating changes', prompt: 'Recent analyst upgrades/downgrades and price target changes' },
        { id: 'options_unusual', name: 'Options unusual activity', prompt: 'Notable unusual options activity or volume spikes' }
    ],
    styles: [
        { id: 'concise', name: 'Concise', word_target: 500, max_tokens: 1000, description: 'Bullet-style key points' },
        { id: 'standard', name: 'Standard', word_target: 1000, max_tokens: 2000, description: 'Structured sections' },
        { id: 'deep_dive', name: 'Deep Dive', word_target: 2000, max_tokens: 3000, description: 'Full analysis' }
    ],
    models: [
        { id: 'claude-sonnet-4-5-20250929', name: 'Sonnet', cost_note: 'Fast, ~$0.05/run' },
        { id: 'claude-opus-4-6', name: 'Opus', cost_note: 'Deep synthesis, ~$0.30/run' }
    ],
    system_prompt: 'You are a senior macro strategist preparing a daily market briefing for a trader focused on S&P 500 and AI infrastructure equities.\n\nRules:\n- Distinguish confirmed data from forecasts/estimates\n- Include probability estimates where available (e.g., CME FedWatch)\n- Prioritize actionable catalysts\n- Note source for key data points\n- Flag anything that changed since yesterday',
    user_prompt_template: 'Generate market briefing for {date}.\nCover the following topics:\n{enabled_topics}\nWatchlist: {watchlist}\nWatchlist coverage: {coverage_types}\nStyle: {briefing_style}\n{custom_instructions}',
    defaults: {
        system_prompt: 'You are a senior macro strategist preparing a daily market briefing for a trader focused on S&P 500 and AI infrastructure equities.\n\nRules:\n- Distinguish confirmed data from forecasts/estimates\n- Include probability estimates where available (e.g., CME FedWatch)\n- Prioritize actionable catalysts\n- Note source for key data points\n- Flag anything that changed since yesterday',
        user_prompt_template: 'Generate market briefing for {date}.\nCover the following topics:\n{enabled_topics}\nWatchlist: {watchlist}\nWatchlist coverage: {coverage_types}\nStyle: {briefing_style}\n{custom_instructions}'
    }
};

const DEFAULT_SETTINGS = {
    default_model: 'claude-sonnet-4-5-20250929',
    enabled_topics: ['fed_policy', 'economic_calendar', 'sp500_technicals', 'vix_sentiment', 'sector_rotation', 'earnings_notable'],
    watchlist: ['NVDA', 'PLTR', 'AMD', 'MRVL', 'VST'],
    enabled_coverage: ['price_moving_news', 'upcoming_earnings'],
    active_style: 'concise',
    custom_instructions: 'Focus on actionable catalysts. Distinguish confirmed data from forecasts. Include probability estimates where available.'
};

// ================================================================
// SECTION 2: STATE MANAGEMENT & LOCALSTORAGE
// ================================================================
function loadApiKey() { return localStorage.getItem('mb_api_key') || null; }
function saveApiKey(key) { localStorage.setItem('mb_api_key', key); }

function loadSettings() {
    try { const s = localStorage.getItem('mb_settings'); return s ? JSON.parse(s) : null; }
    catch(e) { console.error('Error loading settings:', e); return null; }
}
function saveSettings(obj) { localStorage.setItem('mb_settings', JSON.stringify(obj)); }

function loadAdmin() {
    try { const a = localStorage.getItem('mb_admin'); return a ? JSON.parse(a) : null; }
    catch(e) { console.error('Error loading admin:', e); return null; }
}
function saveAdmin(obj) { localStorage.setItem('mb_admin', JSON.stringify(obj)); }

function loadHistory() {
    try { const h = localStorage.getItem('mb_history'); return h ? JSON.parse(h) : []; }
    catch(e) { console.error('Error loading history:', e); return []; }
}
function saveHistory(arr) {
    try { localStorage.setItem('mb_history', JSON.stringify(arr)); }
    catch(e) {
        if (e.name === 'QuotaExceededError') {
            showToast('Storage full. Export and clear old history.', 'error');
        }
    }
}

// ================================================================
// SECTION 3: INITIALIZATION & FIRST-RUN
// ================================================================
function initializeApp() {
    if (!loadAdmin()) saveAdmin(JSON.parse(JSON.stringify(DEFAULT_ADMIN)));
    if (!loadSettings()) saveSettings(JSON.parse(JSON.stringify(DEFAULT_SETTINGS)));
    if (!localStorage.getItem('mb_history')) saveHistory([]);

    if (!loadApiKey()) {
        switchTab('settings');
        document.getElementById('settings-banner').innerHTML = '<div class="banner banner-warning"><strong>API Key Required</strong> ‚Äî Enter your Anthropic API key below to get started.</div>';
    } else {
        switchTab('dashboard');
    }
}

// ================================================================
// SECTION 4: TAB NAVIGATION
// ================================================================
function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    const tab = document.getElementById('tab-' + tabName);
    if (tab) tab.classList.add('active');
    const btn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
    if (btn) btn.classList.add('active');

    if (tabName === 'dashboard') renderDashboard();
    else if (tabName === 'history') renderHistory();
    else if (tabName === 'settings') renderSettings();
    else if (tabName === 'admin') renderAdmin();
}

// ================================================================
// SECTION 5: UTILITY FUNCTIONS
// ================================================================
function generateId() {
    if (crypto.randomUUID) return crypto.randomUUID();
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0; return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
    });
}

function formatDate(d) {
    return d.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
}

function formatDateShort(d) {
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function formatTimestamp(iso) {
    return new Date(iso).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
}

function todayISO() { return new Date().toISOString().split('T')[0]; }

function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function debounce(fn, ms) {
    let timer;
    return function(...args) { clearTimeout(timer); timer = setTimeout(() => fn.apply(this, args), ms); };
}

function downloadFile(filename, content, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
}

function copyToClipboard(text) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => showToast('Copied to clipboard', 'success'));
    } else {
        const ta = document.createElement('textarea');
        ta.value = text; document.body.appendChild(ta); ta.select();
        document.execCommand('copy'); document.body.removeChild(ta);
        showToast('Copied to clipboard', 'success');
    }
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = 'toast ' + type;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
}

let modalConfirmCallback = null;
function showConfirm(message, onConfirm) {
    document.getElementById('modal-title').textContent = 'Confirm';
    document.getElementById('modal-body').innerHTML = '<p>' + escapeHtml(message) + '</p>';
    document.getElementById('modal-confirm').style.display = '';
    modalConfirmCallback = onConfirm;
    document.getElementById('modal-overlay').classList.add('visible');
}
function showModal(title, bodyHtml) {
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-body').innerHTML = bodyHtml;
    document.getElementById('modal-confirm').style.display = 'none';
    modalConfirmCallback = null;
    document.getElementById('modal-overlay').classList.add('visible');
}
function hideModal() { document.getElementById('modal-overlay').classList.remove('visible'); }
function closeModal(e) { if (e.target === document.getElementById('modal-overlay')) hideModal(); }
function confirmModal() { if (modalConfirmCallback) modalConfirmCallback(); hideModal(); }

function promptFileUpload(accept, callback) {
    const input = document.createElement('input');
    input.type = 'file'; input.accept = accept;
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => callback(ev.target.result);
        reader.readAsText(file);
    };
    input.click();
}

function renderMarkdown(text) {
    let html = escapeHtml(text);
    // Horizontal rules
    html = html.replace(/^---+$/gm, '<hr>');
    // Headers
    html = html.replace(/^#### (.+)$/gm, '<h4>$1</h4>');
    html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
    html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
    html = html.replace(/^# (.+)$/gm, '<h2>$1</h2>');
    // Bold and italic
    html = html.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
    html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
    // Bullet lists
    html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
    html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
    // Numbered lists
    html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
    // Blockquotes
    html = html.replace(/^&gt; (.+)$/gm, '<blockquote>$1</blockquote>');
    // Paragraphs
    html = html.replace(/\n\n/g, '</p><p>');
    html = '<p>' + html + '</p>';
    // Clean up
    html = html.replace(/<p><(h[234]|ul|ol|hr|blockquote)/g, '<$1');
    html = html.replace(/<\/(h[234]|ul|ol|hr|blockquote)><\/p>/g, '</$1>');
    html = html.replace(/<p>\s*<\/p>/g, '');
    return html;
}

// ================================================================
// SECTION 6: API INTEGRATION
// ================================================================
async function callAnthropicAPI(systemPrompt, userPrompt, modelId, maxTokens) {
    const apiKey = loadApiKey();
    if (!apiKey) throw new Error('API key not configured');

    const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'x-api-key': apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
            model: modelId,
            max_tokens: maxTokens,
            system: systemPrompt,
            tools: [{ type: 'web_search_20250305', name: 'web_search' }],
            messages: [{ role: 'user', content: userPrompt }]
        })
    });

    if (!response.ok) {
        const err = await response.json().catch(() => ({}));
        if (response.status === 429) throw new Error('Rate limited. Please wait a moment and try again.');
        throw new Error(err.error?.message || 'API error: ' + response.status);
    }
    return response.json();
}

function parseAPIResponse(apiResponse) {
    const textParts = [];
    const citations = [];
    if (apiResponse.content) {
        for (const block of apiResponse.content) {
            if (block.type === 'text') textParts.push(block.text);
        }
    }
    return { text: textParts.join('\n'), model: apiResponse.model, usage: apiResponse.usage, citations };
}

async function validateApiKey(key) {
    try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-api-key': key,
                'anthropic-version': '2023-06-01',
                'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
                model: 'claude-sonnet-4-5-20250929',
                max_tokens: 10,
                messages: [{ role: 'user', content: 'Hi' }]
            })
        });
        return response.ok || response.status === 200;
    } catch(e) { return false; }
}

// ================================================================
// SECTION 7: PROMPT ASSEMBLY
// ================================================================
function assemblePrompt() {
    const admin = loadAdmin();
    const settings = loadSettings();
    if (!admin || !settings) return '';

    let prompt = admin.user_prompt_template;
    prompt = prompt.replace('{date}', formatDate(new Date()));
    prompt = prompt.replace('{enabled_topics}', assembleTopicsBlock(admin, settings));
    prompt = prompt.replace('{watchlist}', settings.watchlist.join(', '));
    prompt = prompt.replace('{coverage_types}', assembleCoverageBlock(admin, settings));
    prompt = prompt.replace('{briefing_style}', assembleStyleBlock(admin, settings));
    prompt = prompt.replace('{custom_instructions}', settings.custom_instructions || '');
    prompt = prompt.replace('{topic_hints}', assembleTopicHints(admin, settings));
    return prompt;
}

function assembleTopicsBlock(admin, settings) {
    const cats = [...admin.categories].sort((a, b) => a.sort - b.sort);
    let lines = [];
    for (const cat of cats) {
        const topics = admin.topics.filter(t => t.category === cat.id && settings.enabled_topics.includes(t.id));
        if (topics.length === 0) continue;
        for (const t of topics) {
            lines.push('- ' + t.name + (t.prompt_hint ? ':\n  ' + t.prompt_hint : ''));
        }
    }
    return lines.join('\n');
}

function assembleCoverageBlock(admin, settings) {
    return admin.coverage_types
        .filter(c => settings.enabled_coverage.includes(c.id))
        .map(c => '- ' + c.name + ': ' + c.prompt)
        .join('\n');
}

function assembleStyleBlock(admin, settings) {
    const style = admin.styles.find(s => s.id === settings.active_style);
    if (!style) return settings.active_style;
    return style.name + ' (~' + style.word_target + ' words) - ' + style.description;
}

function assembleTopicHints(admin, settings) {
    return admin.topics
        .filter(t => settings.enabled_topics.includes(t.id))
        .map(t => t.prompt_hint)
        .join('\n');
}

// ================================================================
// SECTION 8: DASHBOARD LOGIC
// ================================================================
let originalPrompt = '';
let currentBriefing = null;

function renderDashboard() {
    const admin = loadAdmin();
    const settings = loadSettings();
    if (!admin || !settings) return;

    const select = document.getElementById('dashboard-model');
    select.innerHTML = admin.models.map(m =>
        '<option value="' + m.id + '"' + (m.id === settings.default_model ? ' selected' : '') + '>' + escapeHtml(m.name) + ' ‚Äî ' + escapeHtml(m.cost_note) + '</option>'
    ).join('');

    if (currentBriefing) {
        displayBriefing(currentBriefing);
    }
}

function buildPrompt() {
    const prompt = assemblePrompt();
    originalPrompt = prompt;
    document.getElementById('prompt-textarea').value = prompt;
    document.getElementById('prompt-section').style.display = '';
    document.getElementById('briefing-section').style.display = 'none';
    document.getElementById('status-section').style.display = 'none';
}

function resetPrompt() {
    const prompt = assemblePrompt();
    originalPrompt = prompt;
    document.getElementById('prompt-textarea').value = prompt;
}

async function runBriefing() {
    const admin = loadAdmin();
    const settings = loadSettings();
    if (!admin || !settings) return;

    const userPrompt = document.getElementById('prompt-textarea').value;
    const isModified = userPrompt !== originalPrompt;
    const selectedModelId = document.getElementById('dashboard-model').value;
    const selectedModel = admin.models.find(m => m.id === selectedModelId);
    const activeStyle = admin.styles.find(s => s.id === settings.active_style);
    const maxTokens = activeStyle ? activeStyle.max_tokens : 2000;

    document.getElementById('status-section').style.display = '';
    document.getElementById('status-text').textContent = 'Generating briefing...';
    document.getElementById('briefing-section').style.display = 'none';
    document.getElementById('btn-run').disabled = true;

    try {
        const rawResponse = await callAnthropicAPI(admin.system_prompt, userPrompt, selectedModelId, maxTokens);
        const parsed = parseAPIResponse(rawResponse);

        const record = {
            id: generateId(),
            date: todayISO(),
            model: selectedModelId,
            model_label: selectedModel ? selectedModel.name : selectedModelId,
            prompt_sent: userPrompt,
            prompt_modified: isModified,
            system_prompt_sent: admin.system_prompt,
            response: parsed.text,
            generated_at: new Date().toISOString(),
            style: settings.active_style,
            topics_enabled: [...settings.enabled_topics]
        };

        const history = loadHistory();
        history.unshift(record);
        saveHistory(history);

        currentBriefing = record;
        displayBriefing(record);
        document.getElementById('status-section').style.display = 'none';
        showToast('Briefing generated successfully', 'success');
    } catch (error) {
        document.getElementById('status-text').innerHTML = '<span style="color:#dc2626">Error: ' + escapeHtml(error.message) + '</span>';
        document.querySelector('#status-section .spinner')?.remove();
    } finally {
        document.getElementById('btn-run').disabled = false;
    }
}

function displayBriefing(record) {
    document.getElementById('briefing-section').style.display = '';
    document.getElementById('briefing-date').textContent = formatDate(new Date(record.date + 'T12:00:00')) + ' ‚Äî Market Briefing';
    document.getElementById('briefing-model').textContent = 'Model: ' + record.model_label;
    document.getElementById('briefing-time').textContent = 'Generated: ' + formatTimestamp(record.generated_at);

    const modFlag = document.getElementById('briefing-modified');
    if (record.prompt_modified) { modFlag.style.display = ''; } else { modFlag.style.display = 'none'; }

    document.getElementById('briefing-content').innerHTML = renderMarkdown(record.response);
}

function viewSentPrompt() {
    if (!currentBriefing) return;
    showModal('Prompt Sent', '<pre>' + escapeHtml(currentBriefing.prompt_sent) + '</pre>');
}

function regenerateBriefing() {
    if (!currentBriefing) return;
    document.getElementById('prompt-textarea').value = currentBriefing.prompt_sent;
    originalPrompt = currentBriefing.prompt_sent;
    document.getElementById('prompt-section').style.display = '';
    runBriefing();
}

function copyBriefing() {
    if (!currentBriefing) return;
    let text = currentBriefing.response;
    if (document.getElementById('chk-snapshot').checked) {
        text += '\n\n' + buildSettingsSnapshotText();
    }
    copyToClipboard(text);
}

function exportBriefingHTML() {
    if (!currentBriefing) return;
    const includeSnapshot = document.getElementById('chk-snapshot').checked;
    const html = buildExportHTML(currentBriefing, includeSnapshot);
    downloadFile('market-briefing-' + currentBriefing.date + '.html', html, 'text/html');
}

function printBriefing() { window.print(); }

function buildSettingsSnapshotText() {
    const admin = loadAdmin();
    const settings = loadSettings();
    if (!admin || !settings) return '';
    const model = admin.models.find(m => m.id === (currentBriefing ? currentBriefing.model : settings.default_model));
    const style = admin.styles.find(s => s.id === (currentBriefing ? currentBriefing.style : settings.active_style));
    const enabledTopicNames = admin.topics.filter(t => settings.enabled_topics.includes(t.id)).map(t => t.name);
    const enabledCovNames = admin.coverage_types.filter(c => settings.enabled_coverage.includes(c.id)).map(c => c.name);

    let text = '--- Settings Snapshot ---\n';
    text += 'Model: ' + (model ? model.name : 'Unknown') + '\n';
    text += 'Style: ' + (style ? style.name + ' (~' + style.word_target + ' words)' : 'Unknown') + '\n';
    text += 'Topics: ' + enabledTopicNames.join(', ') + '\n';
    text += 'Watchlist: ' + settings.watchlist.join(', ') + '\n';
    text += 'Coverage: ' + enabledCovNames.join(', ') + '\n';
    if (settings.custom_instructions) text += 'Custom Instructions: ' + settings.custom_instructions + '\n';
    if (currentBriefing) text += 'Prompt Sent:\n' + currentBriefing.prompt_sent + '\n';
    return text;
}

function buildExportHTML(record, includeSnapshot) {
    let snapshotHtml = '';
    if (includeSnapshot) {
        snapshotHtml = '<details style="margin-top:24px;padding:16px;background:#f9fafb;border:1px solid #e2e5ea;border-radius:6px"><summary style="cursor:pointer;font-weight:600;font-size:14px">Settings Snapshot</summary><pre style="margin-top:12px;white-space:pre-wrap;font-size:13px">' + escapeHtml(buildSettingsSnapshotText()) + '</pre></details>';
    }
    return `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>Market Briefing - ${record.date}</title><style>body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;max-width:800px;margin:0 auto;padding:24px;color:#1a1a2e;line-height:1.7}h1{font-size:1.3rem;border-bottom:2px solid #e2e5ea;padding-bottom:8px}h2{font-size:1.05rem;margin-top:20px;text-transform:uppercase;letter-spacing:0.5px;border-bottom:1px solid #e2e5ea;padding-bottom:4px}.meta{color:#666;font-size:0.85rem;margin-bottom:16px}ul{margin:8px 0 12px 20px}li{margin-bottom:4px}hr{border:none;border-top:1px solid #e2e5ea;margin:16px 0}strong{color:#1a1a2e}</style></head><body><h1>Market Briefing ‚Äî ${formatDate(new Date(record.date + 'T12:00:00'))}</h1><div class="meta">Model: ${escapeHtml(record.model_label)} | Generated: ${formatTimestamp(record.generated_at)}${record.prompt_modified ? ' | <em>Modified from template</em>' : ''}</div>${renderMarkdown(record.response)}${snapshotHtml}</body></html>`;
}

// ================================================================
// SECTION 9: HISTORY LOGIC
// ================================================================
let historyCompareIds = [];
let viewingHistoryEntry = null;

function renderHistory() {
    const history = loadHistory();
    const searchTerm = (document.getElementById('history-search')?.value || '').toLowerCase();
    const listEl = document.getElementById('history-list');
    document.getElementById('history-view').style.display = 'none';
    document.getElementById('history-compare').style.display = 'none';
    historyCompareIds = [];
    document.getElementById('history-compare-row').style.display = 'none';

    const filtered = searchTerm
        ? history.filter(h => h.response.toLowerCase().includes(searchTerm) || h.date.includes(searchTerm) || h.model_label.toLowerCase().includes(searchTerm))
        : history;

    if (filtered.length === 0) {
        listEl.innerHTML = '<div class="no-history">' + (searchTerm ? 'No matching briefings found.' : 'No briefings generated yet. Go to Dashboard to create your first briefing.') + '</div>';
        return;
    }

    listEl.innerHTML = '<div class="history-list">' + filtered.map(h => {
        const preview = h.response.substring(0, 80).replace(/[#*\-\n]/g, ' ').trim() + '...';
        const d = new Date(h.date + 'T12:00:00');
        return '<div class="history-item" data-id="' + h.id + '"><input type="checkbox" class="history-compare-cb" data-id="' + h.id + '" onclick="toggleCompare(event)"><span class="history-date">' + formatDateShort(d) + '</span><span class="history-model"><span class="status-dot ' + (h.model_label === 'Opus' ? 'orange' : 'green') + '"></span>' + escapeHtml(h.model_label) + '</span><span class="history-preview">' + escapeHtml(preview) + '</span></div>';
    }).join('') + '</div>';

    listEl.querySelectorAll('.history-item').forEach(item => {
        item.addEventListener('click', (e) => {
            if (e.target.classList.contains('history-compare-cb')) return;
            viewHistoryEntry(item.dataset.id);
        });
    });
}

function toggleCompare(e) {
    e.stopPropagation();
    const id = e.target.dataset.id;
    if (e.target.checked) {
        historyCompareIds.push(id);
        if (historyCompareIds.length > 2) {
            const removeId = historyCompareIds.shift();
            const cb = document.querySelector('.history-compare-cb[data-id="' + removeId + '"]');
            if (cb) cb.checked = false;
        }
    } else {
        historyCompareIds = historyCompareIds.filter(i => i !== id);
    }
    document.getElementById('history-compare-row').style.display = historyCompareIds.length === 2 ? '' : 'none';
}

function viewHistoryEntry(id) {
    const history = loadHistory();
    const entry = history.find(h => h.id === id);
    if (!entry) return;
    viewingHistoryEntry = entry;

    document.querySelector('#tab-history > .card').style.display = 'none';
    document.getElementById('history-view').style.display = '';

    const d = new Date(entry.date + 'T12:00:00');
    document.getElementById('history-briefing-header').innerHTML = '<h3>' + formatDate(d) + ' ‚Äî Market Briefing</h3><div class="briefing-meta"><span>Model: ' + escapeHtml(entry.model_label) + '</span><span>Generated: ' + formatTimestamp(entry.generated_at) + '</span>' + (entry.prompt_modified ? '<span class="modified-flag">[modified from template]</span>' : '') + '</div>';
    document.getElementById('history-briefing-content').innerHTML = renderMarkdown(entry.response);
}

function viewHistoryPrompt() {
    if (!viewingHistoryEntry) return;
    let body = '<h4>User Prompt</h4><pre>' + escapeHtml(viewingHistoryEntry.prompt_sent) + '</pre>';
    if (viewingHistoryEntry.system_prompt_sent) {
        body += '<h4 style="margin-top:12px">System Prompt</h4><pre>' + escapeHtml(viewingHistoryEntry.system_prompt_sent) + '</pre>';
    }
    showModal('Prompt Sent', body);
}

function compareSelected() {
    if (historyCompareIds.length !== 2) return;
    const history = loadHistory();
    const a = history.find(h => h.id === historyCompareIds[0]);
    const b = history.find(h => h.id === historyCompareIds[1]);
    if (!a || !b) return;

    document.querySelector('#tab-history > .card').style.display = 'none';
    document.getElementById('history-compare').style.display = '';

    const renderSide = (entry) => {
        const d = new Date(entry.date + 'T12:00:00');
        return '<h4>' + formatDate(d) + ' ‚Äî ' + escapeHtml(entry.model_label) + '</h4>' + renderMarkdown(entry.response);
    };
    document.getElementById('compare-left').innerHTML = renderSide(a);
    document.getElementById('compare-right').innerHTML = renderSide(b);
}

function backToHistoryList() {
    document.querySelector('#tab-history > .card').style.display = '';
    document.getElementById('history-view').style.display = 'none';
    document.getElementById('history-compare').style.display = 'none';
    viewingHistoryEntry = null;
    renderHistory();
}

// ================================================================
// SECTION 10: SETTINGS LOGIC
// ================================================================
let settingsWatchlist = [];

function renderSettings() {
    const admin = loadAdmin();
    const settings = loadSettings();
    if (!admin || !settings) return;

    // API Key
    const key = loadApiKey();
    const keyInput = document.getElementById('settings-apikey');
    if (key) keyInput.value = key;
    updateApiKeyStatus(!!key);

    // Models
    document.getElementById('settings-models').innerHTML = admin.models.map(m =>
        '<label class="radio-option"><input type="radio" name="settings-model" value="' + m.id + '"' + (m.id === settings.default_model ? ' checked' : '') + '><div class="option-info"><div class="option-label">' + escapeHtml(m.name) + '</div><div class="option-desc">' + escapeHtml(m.cost_note) + '</div></div></label>'
    ).join('');

    // Topics grouped by category
    const cats = [...admin.categories].sort((a, b) => a.sort - b.sort);
    let topicsHtml = '';
    for (const cat of cats) {
        const topics = admin.topics.filter(t => t.category === cat.id);
        if (topics.length === 0) continue;
        topicsHtml += '<div class="topic-group-label">' + escapeHtml(cat.name) + '</div><div class="checkbox-group">';
        topicsHtml += topics.map(t =>
            '<label class="checkbox-option"><input type="checkbox" name="settings-topic" value="' + t.id + '"' + (settings.enabled_topics.includes(t.id) ? ' checked' : '') + '><div class="option-info"><div class="option-label">' + escapeHtml(t.name) + '</div></div></label>'
        ).join('');
        topicsHtml += '</div>';
    }
    document.getElementById('settings-topics').innerHTML = topicsHtml;

    // Watchlist
    settingsWatchlist = [...settings.watchlist];
    renderWatchlistTags();

    // Coverage
    document.getElementById('settings-coverage').innerHTML = admin.coverage_types.map(c =>
        '<label class="checkbox-option"><input type="checkbox" name="settings-coverage" value="' + c.id + '"' + (settings.enabled_coverage.includes(c.id) ? ' checked' : '') + '><div class="option-info"><div class="option-label">' + escapeHtml(c.name) + '</div><div class="option-desc">' + escapeHtml(c.prompt) + '</div></div></label>'
    ).join('');

    // Styles
    document.getElementById('settings-styles').innerHTML = admin.styles.map(s =>
        '<label class="radio-option"><input type="radio" name="settings-style" value="' + s.id + '"' + (s.id === settings.active_style ? ' checked' : '') + '><div class="option-info"><div class="option-label">' + escapeHtml(s.name) + ' (~' + s.word_target + ' words)</div><div class="option-desc">' + escapeHtml(s.description) + '</div></div></label>'
    ).join('');

    // Custom Instructions
    document.getElementById('settings-instructions').value = settings.custom_instructions || '';
}

function renderWatchlistTags() {
    const container = document.getElementById('watchlist-tags');
    container.innerHTML = settingsWatchlist.map(t =>
        '<span class="tag">' + escapeHtml(t) + ' <span class="tag-remove" onclick="removeWatchlistTicker(\'' + t + '\')">&times;</span></span>'
    ).join('');
}

function addWatchlistTicker() {
    const input = document.getElementById('watchlist-input');
    const ticker = input.value.trim().toUpperCase();
    if (!ticker || ticker.length > 5 || !/^[A-Z0-9]+$/.test(ticker)) { showToast('Enter a valid ticker (1-5 alphanumeric)', 'error'); return; }
    if (settingsWatchlist.includes(ticker)) { showToast('Ticker already in watchlist', 'error'); return; }
    settingsWatchlist.push(ticker);
    renderWatchlistTags();
    input.value = '';
}

function removeWatchlistTicker(ticker) {
    settingsWatchlist = settingsWatchlist.filter(t => t !== ticker);
    renderWatchlistTags();
}

function updateApiKeyStatus(valid) {
    const el = document.getElementById('apikey-status');
    if (valid) {
        el.innerHTML = '<span class="status-dot green"></span> Connected';
    } else {
        el.innerHTML = '<span class="status-dot gray"></span> Not Set';
    }
}

function toggleApiKeyVis() {
    const input = document.getElementById('settings-apikey');
    const btn = input.nextElementSibling;
    if (input.type === 'password') { input.type = 'text'; btn.textContent = 'Hide'; }
    else { input.type = 'password'; btn.textContent = 'Show'; }
}

async function saveAllSettings() {
    const apiKey = document.getElementById('settings-apikey').value.trim();
    if (apiKey) {
        saveApiKey(apiKey);
        const valid = await validateApiKey(apiKey);
        updateApiKeyStatus(valid);
        if (!valid) showToast('API key could not be validated. It was saved but may not work.', 'error');
        document.getElementById('settings-banner').innerHTML = '';
    }

    const modelRadio = document.querySelector('input[name="settings-model"]:checked');
    const styleRadio = document.querySelector('input[name="settings-style"]:checked');
    const enabledTopics = Array.from(document.querySelectorAll('input[name="settings-topic"]:checked')).map(cb => cb.value);
    const enabledCoverage = Array.from(document.querySelectorAll('input[name="settings-coverage"]:checked')).map(cb => cb.value);

    const settings = {
        default_model: modelRadio ? modelRadio.value : 'claude-sonnet-4-5-20250929',
        enabled_topics: enabledTopics,
        watchlist: [...settingsWatchlist],
        enabled_coverage: enabledCoverage,
        active_style: styleRadio ? styleRadio.value : 'concise',
        custom_instructions: document.getElementById('settings-instructions').value
    };
    saveSettings(settings);
    showToast('Settings saved', 'success');
}

// ================================================================
// SECTION 11: ADMIN LOGIC
// ================================================================
function renderAdmin() {
    renderTopicManagement();
    renderCategoryManagement();
    renderCoverageTypeManagement();
    renderPromptEditor();
    renderStyleManagement();
    renderModelManagement();
}

function toggleAdminForm(formId) {
    const form = document.getElementById(formId);
    form.classList.toggle('visible');
}

// --- Topics ---
function renderTopicManagement() {
    const admin = loadAdmin();
    if (!admin) return;

    const filterSelect = document.getElementById('admin-topic-filter');
    const currentFilter = filterSelect.value;
    filterSelect.innerHTML = '<option value="all">All Categories</option>' + admin.categories.sort((a,b) => a.sort - b.sort).map(c => '<option value="' + c.id + '">' + escapeHtml(c.name) + '</option>').join('');
    filterSelect.value = currentFilter || 'all';

    const topics = currentFilter && currentFilter !== 'all'
        ? admin.topics.filter(t => t.category === currentFilter)
        : admin.topics;

    document.getElementById('admin-topic-list').innerHTML = topics.map(t => {
        const cat = admin.categories.find(c => c.id === t.category);
        return '<div class="admin-item"><div class="admin-item-info"><div class="admin-item-name">' + escapeHtml(t.name) + '</div><div class="admin-item-meta">Key: ' + escapeHtml(t.id) + (cat ? ' | Category: ' + escapeHtml(cat.name) : '') + '</div>' + (t.prompt_hint ? '<div class="admin-item-hint">' + escapeHtml(t.prompt_hint) + '</div>' : '') + '</div><div class="admin-item-actions"><button class="btn btn-icon btn-sm" onclick="editTopic(\'' + t.id + '\')" title="Edit">‚úé</button><button class="btn btn-icon btn-sm btn-danger" onclick="deleteTopic(\'' + t.id + '\')" title="Delete">üóë</button></div></div>';
    }).join('');

    // Update topic form category dropdown
    document.getElementById('topic-form-category').innerHTML = admin.categories.sort((a,b) => a.sort - b.sort).map(c => '<option value="' + c.id + '">' + escapeHtml(c.name) + '</option>').join('');
}

function autoGenerateKey() {
    const name = document.getElementById('topic-form-name').value;
    document.getElementById('topic-form-key').value = name.toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '_').substring(0, 30);
}

function editTopic(id) {
    const admin = loadAdmin();
    const topic = admin.topics.find(t => t.id === id);
    if (!topic) return;
    document.getElementById('topic-form-category').value = topic.category;
    document.getElementById('topic-form-name').value = topic.name;
    document.getElementById('topic-form-key').value = topic.id;
    document.getElementById('topic-form-hint').value = topic.prompt_hint || '';
    document.getElementById('topic-form-edit-id').value = id;
    document.getElementById('topic-form').classList.add('visible');
    document.getElementById('btn-add-topic').textContent = '‚àí Cancel';
}

function saveTopic() {
    const admin = loadAdmin();
    const editId = document.getElementById('topic-form-edit-id').value;
    const category = document.getElementById('topic-form-category').value;
    const name = document.getElementById('topic-form-name').value.trim();
    const key = document.getElementById('topic-form-key').value.trim();
    const hint = document.getElementById('topic-form-hint').value.trim();

    if (!name || !key) { showToast('Name and key are required', 'error'); return; }

    if (editId) {
        const idx = admin.topics.findIndex(t => t.id === editId);
        if (idx !== -1) {
            // If key changed, update settings.enabled_topics too
            if (editId !== key) {
                const settings = loadSettings();
                const si = settings.enabled_topics.indexOf(editId);
                if (si !== -1) settings.enabled_topics[si] = key;
                saveSettings(settings);
            }
            admin.topics[idx] = { id: key, name, category, prompt_hint: hint };
        }
    } else {
        if (admin.topics.find(t => t.id === key)) { showToast('Topic key already exists', 'error'); return; }
        admin.topics.push({ id: key, name, category, prompt_hint: hint });
    }
    saveAdmin(admin);
    cancelTopicForm();
    renderTopicManagement();
    showToast('Topic saved', 'success');
}

function deleteTopic(id) {
    showConfirm('Delete this topic?', () => {
        const admin = loadAdmin();
        admin.topics = admin.topics.filter(t => t.id !== id);
        saveAdmin(admin);
        const settings = loadSettings();
        settings.enabled_topics = settings.enabled_topics.filter(t => t !== id);
        saveSettings(settings);
        renderTopicManagement();
        showToast('Topic deleted', 'success');
    });
}

function cancelTopicForm() {
    document.getElementById('topic-form').classList.remove('visible');
    document.getElementById('topic-form-name').value = '';
    document.getElementById('topic-form-key').value = '';
    document.getElementById('topic-form-hint').value = '';
    document.getElementById('topic-form-edit-id').value = '';
    document.getElementById('btn-add-topic').textContent = '+ Add Topic';
}

// --- Categories ---
function renderCategoryManagement() {
    const admin = loadAdmin();
    if (!admin) return;
    document.getElementById('admin-category-list').innerHTML = admin.categories.sort((a,b) => a.sort - b.sort).map(c =>
        '<div class="admin-item"><div class="admin-item-info"><div class="admin-item-name">' + escapeHtml(c.name) + '</div><div class="admin-item-meta">Sort: ' + c.sort + '</div></div><div class="admin-item-actions"><button class="btn btn-icon btn-sm" onclick="editCategory(\'' + c.id + '\')" title="Edit">‚úé</button><button class="btn btn-icon btn-sm btn-danger" onclick="deleteCategory(\'' + c.id + '\')" title="Delete">üóë</button></div></div>'
    ).join('');
}

function editCategory(id) {
    const admin = loadAdmin();
    const cat = admin.categories.find(c => c.id === id);
    if (!cat) return;
    document.getElementById('category-form-name').value = cat.name;
    document.getElementById('category-form-sort').value = cat.sort;
    document.getElementById('category-form-edit-id').value = id;
    document.getElementById('category-form').classList.add('visible');
}

function saveCategory() {
    const admin = loadAdmin();
    const editId = document.getElementById('category-form-edit-id').value;
    const name = document.getElementById('category-form-name').value.trim();
    const sort = parseInt(document.getElementById('category-form-sort').value) || 1;
    if (!name) { showToast('Name is required', 'error'); return; }
    const key = name.toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '_').substring(0, 30);

    if (editId) {
        const idx = admin.categories.findIndex(c => c.id === editId);
        if (idx !== -1) {
            admin.categories[idx].name = name;
            admin.categories[idx].sort = sort;
        }
    } else {
        if (admin.categories.find(c => c.id === key)) { showToast('Category already exists', 'error'); return; }
        admin.categories.push({ id: key, name, sort });
    }
    saveAdmin(admin);
    cancelCategoryForm();
    renderCategoryManagement();
    renderTopicManagement();
    showToast('Category saved', 'success');
}

function deleteCategory(id) {
    const admin = loadAdmin();
    const topicsInCat = admin.topics.filter(t => t.category === id);
    if (topicsInCat.length > 0) {
        showToast('Cannot delete ‚Äî ' + topicsInCat.length + ' topic(s) in this category. Remove or reassign them first.', 'error');
        return;
    }
    showConfirm('Delete this category?', () => {
        admin.categories = admin.categories.filter(c => c.id !== id);
        saveAdmin(admin);
        renderCategoryManagement();
        showToast('Category deleted', 'success');
    });
}

function cancelCategoryForm() {
    document.getElementById('category-form').classList.remove('visible');
    document.getElementById('category-form-name').value = '';
    document.getElementById('category-form-sort').value = '1';
    document.getElementById('category-form-edit-id').value = '';
}

// --- Coverage Types ---
function renderCoverageTypeManagement() {
    const admin = loadAdmin();
    if (!admin) return;
    document.getElementById('admin-coverage-list').innerHTML = admin.coverage_types.map(c =>
        '<div class="admin-item"><div class="admin-item-info"><div class="admin-item-name">' + escapeHtml(c.name) + '</div><div class="admin-item-hint">' + escapeHtml(c.prompt) + '</div></div><div class="admin-item-actions"><button class="btn btn-icon btn-sm" onclick="editCoverageType(\'' + c.id + '\')" title="Edit">‚úé</button><button class="btn btn-icon btn-sm btn-danger" onclick="deleteCoverageType(\'' + c.id + '\')" title="Delete">üóë</button></div></div>'
    ).join('');
}

function editCoverageType(id) {
    const admin = loadAdmin();
    const ct = admin.coverage_types.find(c => c.id === id);
    if (!ct) return;
    document.getElementById('coverage-form-name').value = ct.name;
    document.getElementById('coverage-form-prompt').value = ct.prompt;
    document.getElementById('coverage-form-edit-id').value = id;
    document.getElementById('coverage-form').classList.add('visible');
}

function saveCoverageType() {
    const admin = loadAdmin();
    const editId = document.getElementById('coverage-form-edit-id').value;
    const name = document.getElementById('coverage-form-name').value.trim();
    const prompt = document.getElementById('coverage-form-prompt').value.trim();
    if (!name || !prompt) { showToast('Name and prompt are required', 'error'); return; }
    const key = name.toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '_').substring(0, 30);

    if (editId) {
        const idx = admin.coverage_types.findIndex(c => c.id === editId);
        if (idx !== -1) { admin.coverage_types[idx].name = name; admin.coverage_types[idx].prompt = prompt; }
    } else {
        if (admin.coverage_types.find(c => c.id === key)) { showToast('Coverage type already exists', 'error'); return; }
        admin.coverage_types.push({ id: key, name, prompt });
    }
    saveAdmin(admin);
    cancelCoverageForm();
    renderCoverageTypeManagement();
    showToast('Coverage type saved', 'success');
}

function deleteCoverageType(id) {
    showConfirm('Delete this coverage type?', () => {
        const admin = loadAdmin();
        admin.coverage_types = admin.coverage_types.filter(c => c.id !== id);
        saveAdmin(admin);
        const settings = loadSettings();
        settings.enabled_coverage = settings.enabled_coverage.filter(c => c !== id);
        saveSettings(settings);
        renderCoverageTypeManagement();
        showToast('Coverage type deleted', 'success');
    });
}

function cancelCoverageForm() {
    document.getElementById('coverage-form').classList.remove('visible');
    document.getElementById('coverage-form-name').value = '';
    document.getElementById('coverage-form-prompt').value = '';
    document.getElementById('coverage-form-edit-id').value = '';
}

// --- Prompt Editor ---
function renderPromptEditor() {
    const admin = loadAdmin();
    if (!admin) return;
    document.getElementById('admin-system-prompt').value = admin.system_prompt;
    document.getElementById('admin-user-template').value = admin.user_prompt_template;
    document.getElementById('prompt-preview').style.display = 'none';
}

function saveSystemPrompt() {
    const admin = loadAdmin();
    admin.system_prompt = document.getElementById('admin-system-prompt').value;
    saveAdmin(admin);
    showToast('System prompt saved', 'success');
}

function saveUserTemplate() {
    const admin = loadAdmin();
    admin.user_prompt_template = document.getElementById('admin-user-template').value;
    saveAdmin(admin);
    showToast('User prompt template saved', 'success');
}

function resetSystemPrompt() {
    const admin = loadAdmin();
    document.getElementById('admin-system-prompt').value = admin.defaults.system_prompt;
    admin.system_prompt = admin.defaults.system_prompt;
    saveAdmin(admin);
    showToast('System prompt reset to default', 'success');
}

function resetUserTemplate() {
    const admin = loadAdmin();
    document.getElementById('admin-user-template').value = admin.defaults.user_prompt_template;
    admin.user_prompt_template = admin.defaults.user_prompt_template;
    saveAdmin(admin);
    showToast('User prompt template reset to default', 'success');
}

function previewFullPrompt() {
    const preview = document.getElementById('prompt-preview');
    if (preview.style.display !== 'none') { preview.style.display = 'none'; return; }
    preview.textContent = assemblePrompt();
    preview.style.display = '';
}

// --- Styles ---
function renderStyleManagement() {
    const admin = loadAdmin();
    if (!admin) return;
    document.getElementById('admin-style-list').innerHTML = admin.styles.map(s =>
        '<div class="admin-item"><div class="admin-item-info"><div class="admin-item-name">' + escapeHtml(s.name) + '</div><div class="admin-item-meta">~' + s.word_target + ' words | ' + s.max_tokens + ' max tokens | ' + escapeHtml(s.description) + '</div></div><div class="admin-item-actions"><button class="btn btn-icon btn-sm" onclick="editStyle(\'' + s.id + '\')" title="Edit">‚úé</button><button class="btn btn-icon btn-sm btn-danger" onclick="deleteStyle(\'' + s.id + '\')" title="Delete">üóë</button></div></div>'
    ).join('');
}

function editStyle(id) {
    const admin = loadAdmin();
    const style = admin.styles.find(s => s.id === id);
    if (!style) return;
    document.getElementById('style-form-name').value = style.name;
    document.getElementById('style-form-words').value = style.word_target;
    document.getElementById('style-form-tokens').value = style.max_tokens;
    document.getElementById('style-form-desc').value = style.description || '';
    document.getElementById('style-form-edit-id').value = id;
    document.getElementById('style-form').classList.add('visible');
}

function saveStyle() {
    const admin = loadAdmin();
    const editId = document.getElementById('style-form-edit-id').value;
    const name = document.getElementById('style-form-name').value.trim();
    const wordTarget = parseInt(document.getElementById('style-form-words').value) || 500;
    const maxTokens = parseInt(document.getElementById('style-form-tokens').value) || 1000;
    const description = document.getElementById('style-form-desc').value.trim();
    if (!name) { showToast('Name is required', 'error'); return; }
    const key = name.toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '_').substring(0, 30);

    if (editId) {
        const idx = admin.styles.findIndex(s => s.id === editId);
        if (idx !== -1) {
            admin.styles[idx].name = name;
            admin.styles[idx].word_target = wordTarget;
            admin.styles[idx].max_tokens = maxTokens;
            admin.styles[idx].description = description;
        }
    } else {
        if (admin.styles.find(s => s.id === key)) { showToast('Style already exists', 'error'); return; }
        admin.styles.push({ id: key, name, word_target: wordTarget, max_tokens: maxTokens, description });
    }
    saveAdmin(admin);
    cancelStyleForm();
    renderStyleManagement();
    showToast('Style saved', 'success');
}

function deleteStyle(id) {
    showConfirm('Delete this style?', () => {
        const admin = loadAdmin();
        admin.styles = admin.styles.filter(s => s.id !== id);
        saveAdmin(admin);
        const settings = loadSettings();
        if (settings.active_style === id) {
            settings.active_style = admin.styles.length > 0 ? admin.styles[0].id : 'concise';
            saveSettings(settings);
        }
        renderStyleManagement();
        showToast('Style deleted', 'success');
    });
}

function cancelStyleForm() {
    document.getElementById('style-form').classList.remove('visible');
    document.getElementById('style-form-name').value = '';
    document.getElementById('style-form-words').value = '500';
    document.getElementById('style-form-tokens').value = '1000';
    document.getElementById('style-form-desc').value = '';
    document.getElementById('style-form-edit-id').value = '';
}

// --- Models ---
function renderModelManagement() {
    const admin = loadAdmin();
    if (!admin) return;
    document.getElementById('admin-model-list').innerHTML = admin.models.map(m =>
        '<div class="admin-item"><div class="admin-item-info"><div class="admin-item-name">' + escapeHtml(m.name) + '</div><div class="admin-item-meta">' + escapeHtml(m.id) + ' | ' + escapeHtml(m.cost_note) + '</div></div><div class="admin-item-actions"><button class="btn btn-icon btn-sm" onclick="editModel(\'' + m.id + '\')" title="Edit">‚úé</button><button class="btn btn-icon btn-sm btn-danger" onclick="deleteModel(\'' + m.id + '\')" title="Delete">üóë</button></div></div>'
    ).join('');
}

function editModel(id) {
    const admin = loadAdmin();
    const model = admin.models.find(m => m.id === id);
    if (!model) return;
    document.getElementById('model-form-id').value = model.id;
    document.getElementById('model-form-name').value = model.name;
    document.getElementById('model-form-cost').value = model.cost_note || '';
    document.getElementById('model-form-edit-id').value = id;
    document.getElementById('model-form').classList.add('visible');
}

function saveModel() {
    const admin = loadAdmin();
    const editId = document.getElementById('model-form-edit-id').value;
    const apiId = document.getElementById('model-form-id').value.trim();
    const name = document.getElementById('model-form-name').value.trim();
    const costNote = document.getElementById('model-form-cost').value.trim();
    if (!apiId || !name) { showToast('API Model ID and name are required', 'error'); return; }

    if (editId) {
        const idx = admin.models.findIndex(m => m.id === editId);
        if (idx !== -1) {
            // Update settings if default_model was this model
            if (editId !== apiId) {
                const settings = loadSettings();
                if (settings.default_model === editId) {
                    settings.default_model = apiId;
                    saveSettings(settings);
                }
            }
            admin.models[idx] = { id: apiId, name, cost_note: costNote };
        }
    } else {
        if (admin.models.find(m => m.id === apiId)) { showToast('Model ID already exists', 'error'); return; }
        admin.models.push({ id: apiId, name, cost_note: costNote });
    }
    saveAdmin(admin);
    cancelModelForm();
    renderModelManagement();
    showToast('Model saved', 'success');
}

function deleteModel(id) {
    showConfirm('Delete this model?', () => {
        const admin = loadAdmin();
        admin.models = admin.models.filter(m => m.id !== id);
        saveAdmin(admin);
        const settings = loadSettings();
        if (settings.default_model === id) {
            settings.default_model = admin.models.length > 0 ? admin.models[0].id : '';
            saveSettings(settings);
        }
        renderModelManagement();
        showToast('Model deleted', 'success');
    });
}

function cancelModelForm() {
    document.getElementById('model-form').classList.remove('visible');
    document.getElementById('model-form-id').value = '';
    document.getElementById('model-form-name').value = '';
    document.getElementById('model-form-cost').value = '';
    document.getElementById('model-form-edit-id').value = '';
}

// ================================================================
// SECTION 12: EXPORT / IMPORT / DATA MANAGEMENT
// ================================================================
function exportSettings() {
    const data = { mb_settings: loadSettings(), mb_api_key: loadApiKey() };
    downloadFile('market-briefing-settings-' + todayISO() + '.json', JSON.stringify(data, null, 2), 'application/json');
    showToast('Settings exported', 'success');
}

function importSettings() {
    promptFileUpload('.json', (content) => {
        try {
            const data = JSON.parse(content);
            if (data.mb_settings) saveSettings(data.mb_settings);
            if (data.mb_api_key) saveApiKey(data.mb_api_key);
            renderSettings();
            showToast('Settings imported', 'success');
        } catch(e) { showToast('Invalid file format', 'error'); }
    });
}

function exportHistory() {
    const history = loadHistory();
    downloadFile('market-briefing-history-' + todayISO() + '.json', JSON.stringify(history, null, 2), 'application/json');
    showToast('History exported', 'success');
}

function importHistory() {
    promptFileUpload('.json', (content) => {
        try {
            const imported = JSON.parse(content);
            if (!Array.isArray(imported)) throw new Error('Invalid');
            const existing = loadHistory();
            const existingIds = new Set(existing.map(h => h.id));
            const newEntries = imported.filter(h => h.id && !existingIds.has(h.id));
            const merged = [...existing, ...newEntries].sort((a, b) => new Date(b.generated_at) - new Date(a.generated_at));
            saveHistory(merged);
            renderHistory();
            showToast('History imported (' + newEntries.length + ' new entries)', 'success');
        } catch(e) { showToast('Invalid file format', 'error'); }
    });
}

function exportEverything() {
    const data = {
        mb_api_key: loadApiKey(),
        mb_settings: loadSettings(),
        mb_admin: loadAdmin(),
        mb_history: loadHistory()
    };
    downloadFile('market-briefing-backup-' + todayISO() + '.json', JSON.stringify(data, null, 2), 'application/json');
    showToast('Full backup exported', 'success');
}

function importEverything() {
    promptFileUpload('.json', (content) => {
        try {
            const data = JSON.parse(content);
            if (data.mb_api_key) saveApiKey(data.mb_api_key);
            if (data.mb_settings) saveSettings(data.mb_settings);
            if (data.mb_admin) saveAdmin(data.mb_admin);
            if (data.mb_history) saveHistory(data.mb_history);
            renderSettings();
            showToast('Full backup restored', 'success');
        } catch(e) { showToast('Invalid file format', 'error'); }
    });
}

function clearHistoryOnly() {
    showConfirm('Delete all briefing history? This cannot be undone.', () => {
        saveHistory([]);
        currentBriefing = null;
        showToast('History cleared', 'success');
    });
}

function resetEverything() {
    showConfirm('Reset everything to factory defaults? All settings, history, and admin config will be erased.', () => {
        localStorage.removeItem('mb_api_key');
        localStorage.removeItem('mb_settings');
        localStorage.removeItem('mb_admin');
        localStorage.removeItem('mb_history');
        currentBriefing = null;
        initializeApp();
        showToast('Reset to defaults', 'success');
    });
}

// ================================================================
// SECTION 13: EVENT LISTENERS & STARTUP
// ================================================================
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => switchTab(btn.dataset.tab));
});

document.getElementById('watchlist-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); addWatchlistTicker(); }
});

document.getElementById('history-search').addEventListener('input', debounce(renderHistory, 300));

function scrollGuide(id) {
    const el = document.getElementById(id);
    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Start the app
initializeApp();
    </script>
</body>
</html>
